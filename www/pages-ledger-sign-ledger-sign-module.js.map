{"version":3,"sources":["./src/app/pages/ledger-sign/ledger-sign.ts","./src/app/pages/ledger-sign/ledger-sign.html","./src/app/pages/ledger-sign/ledger-sign.module.ts"],"names":[],"mappings":"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","file":"pages-ledger-sign-ledger-sign-module.js","sourcesContent":["import { Component } from '@angular/core'\nimport { Router, ActivatedRoute } from '@angular/router'\nimport { AirGapMarketWallet, IAirGapTransaction, IACMessageType, generateId, IACMessageDefinitionObjectV3 } from '@airgap/coinlib-core'\nimport BigNumber from 'bignumber.js'\n\nimport { AlertController, LoadingController } from '@ionic/angular'\nimport { TranslateService } from '@ngx-translate/core'\nimport { DataService, DataServiceKey } from 'src/app/services/data/data.service'\nimport { LedgerService } from 'src/app/services/ledger/ledger-service'\nimport { ErrorCategory, handleErrorSentry } from 'src/app/services/sentry-error-handler/sentry-error-handler'\n\n@Component({\n  selector: 'page-ledger-sign',\n  templateUrl: 'ledger-sign.html',\n  styleUrls: ['./ledger-sign.scss']\n})\nexport class LedgerSignPage {\n  public readonly wallet: AirGapMarketWallet = null\n  public readonly airGapTxs: IAirGapTransaction[] = null\n  public readonly aggregatedInfo?: {\n    numberOfTxs: number\n    totalAmount: BigNumber\n    totalFees: BigNumber\n  }\n\n  private readonly unsignedTx: any\n\n  private loader: HTMLIonLoadingElement | undefined\n\n  constructor(\n    private readonly router: Router,\n    private readonly route: ActivatedRoute,\n    private readonly dataService: DataService,\n    private readonly alertCtrl: AlertController,\n    private readonly loadingController: LoadingController,\n    private readonly translateService: TranslateService,\n    private readonly ledgerService: LedgerService\n  ) {\n    if (this.route.snapshot.data.special) {\n      const info = this.route.snapshot.data.special\n      this.wallet = info.wallet\n      this.airGapTxs = info.airGapTxs\n      this.unsignedTx = info.data\n\n      if (\n        this.airGapTxs.length > 1 &&\n        this.airGapTxs.every((tx: IAirGapTransaction) => tx.protocolIdentifier === this.airGapTxs[0].protocolIdentifier)\n      ) {\n        this.aggregatedInfo = {\n          numberOfTxs: this.airGapTxs.length,\n          totalAmount: this.airGapTxs\n            .map((tx: IAirGapTransaction) => new BigNumber(tx.amount))\n            .filter((amount: BigNumber) => !amount.isNaN())\n            .reduce((pv: BigNumber, cv: BigNumber) => pv.plus(cv), new BigNumber(0)),\n          totalFees: this.airGapTxs.reduce((pv: BigNumber, cv: IAirGapTransaction) => pv.plus(cv.fee), new BigNumber(0))\n        }\n      }\n    }\n    this.connectWithLedger()\n  }\n\n  private async connectWithLedger() {\n    await this.showLoader('Connecting device...')\n\n    try {\n      await this.ledgerService.openConnection(this.wallet.protocol.identifier)\n    } catch (error) {\n      console.warn(error)\n      this.promptError(error)\n    } finally {\n      this.dismissLoader()\n    }\n  }\n\n  public async signTx() {\n    await this.showLoader('Signing transaction...')\n\n    try {\n      const signedTx = await this.ledgerService.signTransaction(this.wallet.protocol.identifier, this.unsignedTx)\n      const signedTransactionSync: IACMessageDefinitionObjectV3 = {\n        id: generateId(8),\n        type: IACMessageType.MessageSignResponse,\n        protocol: this.wallet.protocol.identifier,\n        payload: {\n          transaction: signedTx,\n          accountIdentifier: this.wallet.publicKey.substr(-6)\n        }\n      }\n      const info = {\n        messageDefinitionObjects: [signedTransactionSync]\n      }\n      this.dataService.setData(DataServiceKey.TRANSACTION, info)\n      this.router.navigateByUrl(`/transaction-confirm/${DataServiceKey.TRANSACTION}`).catch(handleErrorSentry(ErrorCategory.NAVIGATION))\n    } catch (error) {\n      console.warn(error)\n      this.promptError(error)\n    } finally {\n      this.dismissLoader()\n    }\n  }\n\n  private async promptError(error: unknown) {\n    let message: string\n    if (typeof error === 'string') {\n      if (error === 'Rejected') {\n        return\n      }\n\n      message = error\n    } else if (error instanceof Error) {\n      message = error.message\n    } else {\n      message = this.translateService.instant('ledger-sign.error-alert.unknown')\n    }\n\n    const alert: HTMLIonAlertElement = await this.alertCtrl.create({\n      header: this.translateService.instant('ledger-sign.error-alert.header'),\n      message,\n      buttons: [\n        {\n          text: this.translateService.instant('ledger-sign.error-alert.confirm')\n        }\n      ]\n    })\n    alert.present().catch(handleErrorSentry(ErrorCategory.IONIC_ALERT))\n  }\n\n  private async showLoader(message: string) {\n    this.dismissLoader()\n    this.loader = await this.loadingController.create({ message })\n\n    await this.loader.present().catch(handleErrorSentry(ErrorCategory.IONIC_LOADER))\n  }\n\n  private dismissLoader() {\n    if (this.loader) {\n      this.loader.dismiss().catch(handleErrorSentry(ErrorCategory.IONIC_LOADER))\n      this.loader = null\n    }\n  }\n}\n","<ion-header class=\"ion-no-border\">\n  <ion-grid fixed=\"true\" class=\"ion-no-padding\">\n    <ion-toolbar>\n      <ion-buttons slot=\"start\">\n        <ion-back-button defaultHref=\"/\"></ion-back-button>\n      </ion-buttons>\n      <ion-title>{{ 'ledger-sign.title' | translate: { title: wallet.protocol.identifier | uppercase } }}</ion-title>\n    </ion-toolbar>\n  </ion-grid>\n</ion-header>\n\n<ion-content class=\"ion-padding ion-margin-bottom\">\n  <ion-grid fixed=\"true\" class=\"ion-no-padding\">\n    <ion-row>\n      <h5 [innerHTML]=\"'ledger-sign.text' | translate\"></h5>\n    </ion-row>\n\n    <ng-container *ngIf=\"airGapTxs && airGapTxs.length > 1\">\n      <ion-row class=\"ion-padding-bottom ion-text-center\">\n        <ion-col size=\"4\" class=\"content--align__center-center\">\n          <h5>\n            {{ aggregatedInfo.totalAmount.toFixed() | amountConverter: { protocol: airGapTxs[0].protocolIdentifier, maxDigits: undefined } |\n            async }}\n          </h5>\n        </ion-col>\n        <ion-col size=\"4\" class=\"content--align__center-center\">\n          <h5>{{ aggregatedInfo.numberOfTxs }}</h5>\n        </ion-col>\n        <ion-col size=\"4\" class=\"content--align__center-center\">\n          <h5>{{ aggregatedInfo.totalFees.toFixed() | feeConverter: { protocol: airGapTxs[0].protocolIdentifier } | async }}</h5>\n        </ion-col>\n        <ion-col size=\"4\">\n          <small>Amount</small>\n        </ion-col>\n        <ion-col size=\"4\">\n          <small>Operations</small>\n        </ion-col>\n        <ion-col size=\"4\">\n          <small>Fee</small>\n        </ion-col>\n      </ion-row>\n    </ng-container>\n\n    <ng-container *ngIf=\"airGapTxs\">\n      <airgap-from-to *ngFor=\"let airGapTx of airGapTxs\" class=\"ion-padding-horizontal\" [transaction]=\"airGapTx\"></airgap-from-to>\n    </ng-container>\n  </ion-grid>\n  <ion-fab vertical=\"bottom\" horizontal=\"end\" slot=\"fixed\">\n    <ion-button id=\"confirm\" size=\"default\" color=\"primary\" (click)=\"signTx()\" shape=\"round\">\n      {{ 'ledger-sign.confirm_label' | translate }}\n    </ion-button>\n  </ion-fab>\n</ion-content>\n","import { AirGapAngularCoreModule } from '@airgap/angular-core'\nimport { CommonModule } from '@angular/common'\nimport { NgModule } from '@angular/core'\nimport { RouterModule } from '@angular/router'\nimport { IonicModule } from '@ionic/angular'\nimport { TranslateModule } from '@ngx-translate/core'\nimport { ComponentsModule } from 'src/app/components/components.module'\nimport { PipesModule } from 'src/app/pipes/pipes.module'\n\nimport { LedgerSignPage } from './ledger-sign'\n\n@NgModule({\n  imports: [\n    IonicModule,\n    CommonModule,\n    ComponentsModule,\n    TranslateModule,\n    PipesModule,\n    AirGapAngularCoreModule,\n    RouterModule.forChild([{ path: '', component: LedgerSignPage }])\n  ],\n  declarations: [LedgerSignPage]\n})\nexport class LedgerSignPageModule {}\n"],"sourceRoot":"webpack:///"}